<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pythonæ•™å®¤æ¸¬é©—å¹³å°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .role-selector {
            margin: 20px 0;
        }

        .role-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .role-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .role-btn.active {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .question-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }

        .question-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .code-editor {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
        }

        .CodeMirror {
            height: 300px;
            font-size: 14px;
        }

        .output-section {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            min-height: 100px;
            white-space: pre-wrap;
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }

        .student-card.completed {
            border-color: #4CAF50;
            background: #e8f5e8;
        }

        .student-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-working {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 20px;
        }

        .close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .score-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .student-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ Pythonæ•™å®¤æ¸¬é©—å¹³å°</h1>
            <div class="role-selector">
                <button class="role-btn active" onclick="switchRole('teacher')">æ•™å¸«æ¨¡å¼</button>
                <button class="role-btn" onclick="switchRole('student')">å­¸ç”Ÿæ¨¡å¼</button>
            </div>
        </div>

        <!-- æ•™å¸«é¢æ¿ -->
        <div id="teacher-panel" class="panel active">
            <h2>ğŸ“š æ•™å¸«æ§åˆ¶é¢æ¿</h2>
            
            <!-- å»ºç«‹è©¦é¡Œå€åŸŸ -->
            <div class="form-group">
                <h3>å»ºç«‹æ–°è©¦é¡Œ</h3>
                <label for="question-title">é¡Œç›®æ¨™é¡Œï¼š</label>
                <input type="text" id="question-title" placeholder="ä¾‹ï¼šè¨ˆç®—å…©æ•¸ä¹‹å’Œ">
                
                <label for="question-description">é¡Œç›®æè¿°ï¼š</label>
                <textarea id="question-description" rows="4" placeholder="è«‹è©³ç´°æè¿°é¡Œç›®è¦æ±‚..."></textarea>
                
                <label for="sample-input">ç¯„ä¾‹è¼¸å…¥ï¼š</label>
                <textarea id="sample-input" rows="2" placeholder="3, 5"></textarea>
                
                <label for="sample-output">é æœŸè¼¸å‡ºï¼š</label>
                <textarea id="sample-output" rows="2" placeholder="8"></textarea>
                
                <button class="btn" onclick="createQuestion()">å»ºç«‹é¡Œç›®</button>
                <button class="btn btn-warning" onclick="clearAllQuestions()">æ¸…ç©ºæ‰€æœ‰é¡Œç›®</button>
            </div>

            <!-- ç›®å‰é¡Œç›®åˆ—è¡¨ -->
            <div class="form-group">
                <h3>ğŸ“ ç›®å‰é¡Œç›®</h3>
                <div id="question-list"></div>
            </div>

            <!-- å­¸ç”Ÿç‹€æ…‹ç›£æ§ -->
            <div class="form-group">
                <h3>ğŸ‘¥ å­¸ç”Ÿç‹€æ…‹ç›£æ§ (<span id="student-count">0</span>/35)</h3>
                <button class="btn" onclick="refreshStudentStatus()">åˆ·æ–°ç‹€æ…‹</button>
                <button class="btn btn-warning" onclick="exportResults()">åŒ¯å‡ºçµæœ</button>
                <div id="student-status" class="student-list"></div>
            </div>
        </div>

        <!-- å­¸ç”Ÿé¢æ¿ -->
        <div id="student-panel" class="panel">
            <h2>âœï¸ å­¸ç”Ÿä½œç­”å€</h2>
            
            <!-- å­¸ç”Ÿç™»å…¥ -->
            <div id="student-login" class="form-group">
                <label for="student-name">è«‹è¼¸å…¥æ‚¨çš„å§“åï¼š</label>
                <input type="text" id="student-name" placeholder="ä¾‹ï¼šå¼µå°æ˜">
                <button class="btn" onclick="studentLogin()">é–‹å§‹ç­”é¡Œ</button>
            </div>

            <!-- ä½œç­”å€åŸŸ -->
            <div id="answer-area" style="display: none;">
                <div class="form-group">
                    <h3>ç•¶å‰é¡Œç›®ï¼š<span id="current-question-title"></span></h3>
                    <div id="current-question-description"></div>
                </div>

                <div class="form-group">
                    <h4>ğŸ’» ç¨‹å¼ç¢¼ç·¨è¼¯å€</h4>
                    <div id="code-editor" class="code-editor"></div>
                    <button class="btn" onclick="runCode()">â–¶ï¸ åŸ·è¡Œç¨‹å¼</button>
                    <button class="btn btn-warning" onclick="submitAnswer()">ğŸ“¤ æäº¤ç­”æ¡ˆ</button>
                </div>

                <div class="form-group">
                    <h4>ğŸ“¤ åŸ·è¡Œçµæœ</h4>
                    <div id="code-output" class="output-section">é»æ“Š"åŸ·è¡Œç¨‹å¼"ä¾†æŸ¥çœ‹çµæœ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æ¡† -->
    <div id="notification" class="notification"></div>

    <!-- æŸ¥çœ‹å­¸ç”Ÿç¨‹å¼ç¢¼çš„æ¨¡æ…‹æ¡† -->
    <div id="code-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modal-student-name"></h3>
            <div id="modal-question-info"></div>
            <div id="modal-code-content" class="code-editor"></div>
            <div class="form-group">
                <label>è©•åˆ†ï¼š</label>
                <input type="number" id="score-input" class="score-input" min="0" max="100" placeholder="åˆ†æ•¸">
                <button class="btn" onclick="saveScore()">å„²å­˜åˆ†æ•¸</button>
            </div>
            <div id="modal-output" class="output-section"></div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentRole = 'teacher';
        let questions = [];
        let students = {};
        let currentStudent = null;
        let codeEditor = null;
        let modalEditor = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeCodeEditor();
            loadData();
            updateQuestionList();
            updateStudentStatus();
        });

        // åˆå§‹åŒ–ç¨‹å¼ç¢¼ç·¨è¼¯å™¨
        function initializeCodeEditor() {
            const editorElement = document.getElementById('code-editor');
            if (editorElement) {
                codeEditor = CodeMirror(editorElement, {
                    mode: 'python',
                    theme: 'monokai',
                    lineNumbers: true,
                    indentUnit: 4,
                    matchBrackets: true,
                    autoCloseBrackets: true,
                    value: '# åœ¨é€™è£¡å¯«ä¸‹æ‚¨çš„Pythonç¨‹å¼ç¢¼\nprint("Hello, Python!")'
                });
            }
        }

        // åˆ‡æ›è§’è‰²
        function switchRole(role) {
            currentRole = role;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.role-btn')).find(btn => 
                btn.textContent.includes(role === 'teacher' ? 'æ•™å¸«' : 'å­¸ç”Ÿ')
            );
            if (activeBtn) activeBtn.classList.add('active');
            
            // é¡¯ç¤ºå°æ‡‰é¢æ¿
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(role + '-panel').classList.add('active');
            
            if (role === 'student') {
                loadQuestions();
            }
            
            // æ›´æ–°é é¢æ¨™é¡Œ
            const titleSuffix = role === 'teacher' ? ' - æ•™å¸«ç«¯' : ' - å­¸ç”Ÿç«¯';
            document.title = 'Pythonæ•™å®¤æ¸¬é©—å¹³å°' + titleSuffix;
        }

        // é¡¯ç¤º/éš±è—ç¶²å€è³‡è¨Š
        function toggleUrlInfo() {
            const urlInfo = document.getElementById('url-info');
            const showBtn = document.getElementById('show-url-btn');
            
            if (urlInfo.style.display === 'none' || urlInfo.style.display === '') {
                urlInfo.style.display = 'block';
                showBtn.style.display = 'none';
                
                // è‡ªå‹•æ›´æ–°ç•¶å‰çš„IPä½å€ï¼ˆå¦‚æœå¯èƒ½çš„è©±ï¼‰
                updateUrlDisplay();
            } else {
                urlInfo.style.display = 'none';
                showBtn.style.display = 'inline-block';
            }
        }

        // æ›´æ–°ç¶²å€é¡¯ç¤º
        function updateUrlDisplay() {
            const currentUrl = window.location.origin + window.location.pathname;
            document.getElementById('teacher-url').textContent = currentUrl + '?admin=1';
            document.getElementById('student-url').textContent = currentUrl;
        }

        // å»ºç«‹é¡Œç›®
        function createQuestion() {
            const title = document.getElementById('question-title').value.trim();
            const description = document.getElementById('question-description').value.trim();
            const sampleInput = document.getElementById('sample-input').value.trim();
            const sampleOutput = document.getElementById('sample-output').value.trim();
            
            if (!title || !description) {
                showNotification('è«‹å¡«å¯«å®Œæ•´çš„é¡Œç›®è³‡è¨Šï¼', 'error');
                return;
            }
            
            const question = {
                id: Date.now(),
                title: title,
                description: description,
                sampleInput: sampleInput,
                sampleOutput: sampleOutput,
                createdAt: new Date().toLocaleString()
            };
            
            questions.push(question);
            saveData();
            updateQuestionList();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('question-title').value = '';
            document.getElementById('question-description').value = '';
            document.getElementById('sample-input').value = '';
            document.getElementById('sample-output').value = '';
            
            showNotification('é¡Œç›®å»ºç«‹æˆåŠŸï¼');
        }

        // æ›´æ–°é¡Œç›®åˆ—è¡¨
        function updateQuestionList() {
            const questionList = document.getElementById('question-list');
            if (questions.length === 0) {
                questionList.innerHTML = '<p style="color: #666;">ç›®å‰æ²’æœ‰é¡Œç›®</p>';
                return;
            }
            
            questionList.innerHTML = questions.map(q => `
                <div class="question-item">
                    <div class="question-title">${q.title}</div>
                    <div style="color: #666; margin-bottom: 10px;">å»ºç«‹æ™‚é–“: ${q.createdAt}</div>
                    <div style="margin-bottom: 10px;">${q.description}</div>
                    ${q.sampleInput ? `<div><strong>ç¯„ä¾‹è¼¸å…¥:</strong> ${q.sampleInput}</div>` : ''}
                    ${q.sampleOutput ? `<div><strong>é æœŸè¼¸å‡º:</strong> ${q.sampleOutput}</div>` : ''}
                    <button class="btn btn-danger" onclick="deleteQuestion(${q.id})" style="margin-top: 10px;">åˆªé™¤é¡Œç›®</button>
                </div>
            `).join('');
        }

        // åˆªé™¤é¡Œç›®
        function deleteQuestion(questionId) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é¡Œç›®å—ï¼Ÿ')) {
                questions = questions.filter(q => q.id !== questionId);
                saveData();
                updateQuestionList();
                showNotification('é¡Œç›®å·²åˆªé™¤ï¼');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰é¡Œç›®
        function clearAllQuestions() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¡Œç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                questions = [];
                students = {};
                saveData();
                updateQuestionList();
                updateStudentStatus();
                showNotification('æ‰€æœ‰é¡Œç›®å·²æ¸…ç©ºï¼');
            }
        }

        // å­¸ç”Ÿç™»å…¥
        function studentLogin() {
            const name = document.getElementById('student-name').value.trim();
            if (!name) {
                showNotification('è«‹è¼¸å…¥æ‚¨çš„å§“åï¼', 'error');
                return;
            }
            
            if (questions.length === 0) {
                showNotification('ç›®å‰æ²’æœ‰å¯ä½œç­”çš„é¡Œç›®ï¼', 'error');
                return;
            }
            
            currentStudent = name;
            
            // åˆå§‹åŒ–å­¸ç”Ÿè³‡æ–™
            if (!students[name]) {
                students[name] = {
                    name: name,
                    loginTime: new Date().toLocaleString(),
                    answers: {},
                    scores: {},
                    status: 'working'
                };
            }
            
            saveData();
            document.getElementById('student-login').style.display = 'none';
            document.getElementById('answer-area').style.display = 'block';
            
            loadCurrentQuestion();
            showNotification(`æ­¡è¿ ${name}ï¼é–‹å§‹ä½œç­”å§ï¼`);
        }

        // è¼‰å…¥ç•¶å‰é¡Œç›®
        function loadCurrentQuestion() {
            if (questions.length > 0) {
                const currentQuestion = questions[0]; // é¡¯ç¤ºç¬¬ä¸€å€‹é¡Œç›®
                document.getElementById('current-question-title').textContent = currentQuestion.title;
                
                let questionHtml = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="margin-bottom: 10px;"><strong>é¡Œç›®æè¿°ï¼š</strong></div>
                        <div style="margin-bottom: 10px;">${currentQuestion.description}</div>
                `;
                
                if (currentQuestion.sampleInput) {
                    questionHtml += `<div style="margin-bottom: 5px;"><strong>ç¯„ä¾‹è¼¸å…¥ï¼š</strong> ${currentQuestion.sampleInput}</div>`;
                }
                
                if (currentQuestion.sampleOutput) {
                    questionHtml += `<div><strong>é æœŸè¼¸å‡ºï¼š</strong> ${currentQuestion.sampleOutput}</div>`;
                }
                
                questionHtml += '</div>';
                
                document.getElementById('current-question-description').innerHTML = questionHtml;
                
                // è¼‰å…¥å·²ä¿å­˜çš„ç¨‹å¼ç¢¼
                if (students[currentStudent] && students[currentStudent].answers[currentQuestion.id]) {
                    codeEditor.setValue(students[currentStudent].answers[currentQuestion.id]);
                }
            }
        }

        // è¼‰å…¥é¡Œç›®ï¼ˆå­¸ç”Ÿæ¨¡å¼ï¼‰
        function loadQuestions() {
            // é€™å€‹å‡½æ•¸åœ¨å­¸ç”Ÿåˆ‡æ›åˆ°å­¸ç”Ÿæ¨¡å¼æ™‚èª¿ç”¨ï¼Œç¢ºä¿æœ‰æœ€æ–°çš„é¡Œç›®
        }

        // åŸ·è¡Œç¨‹å¼ç¢¼
        function runCode() {
            const code = codeEditor.getValue();
            const output = document.getElementById('code-output');
            
            try {
                // æ³¨æ„ï¼šé€™æ˜¯ä¸€å€‹æ¨¡æ“¬çš„PythonåŸ·è¡Œç’°å¢ƒ
                // åœ¨å¯¦éš›éƒ¨ç½²ä¸­ï¼Œæ‚¨éœ€è¦ä¸€å€‹çœŸæ­£çš„Pythonè§£é‡‹å™¨
                output.textContent = 'æ¨¡æ“¬åŸ·è¡Œçµæœï¼š\n' + simulatePythonExecution(code);
            } catch (error) {
                output.textContent = 'åŸ·è¡ŒéŒ¯èª¤ï¼š\n' + error.message;
            }
        }

        // æ¨¡æ“¬PythonåŸ·è¡Œï¼ˆç°¡å–®ç‰ˆæœ¬ï¼‰
        function simulatePythonExecution(code) {
            // é€™æ˜¯ä¸€å€‹éå¸¸ç°¡å–®çš„æ¨¡æ“¬å™¨ï¼Œåƒ…ç”¨æ–¼æ¼”ç¤º
            // å¯¦éš›æ‡‰ç”¨ä¸­éœ€è¦çœŸæ­£çš„Pythonè§£é‡‹å™¨
            
            if (code.includes('print(')) {
                const matches = code.match(/print\((.*?)\)/g);
                if (matches) {
                    return matches.map(match => {
                        const content = match.replace(/print\(|\)/g, '');
                        return eval(content); // æ³¨æ„ï¼šå¯¦éš›ä½¿ç”¨ä¸­ä¸å»ºè­°ä½¿ç”¨eval
                    }).join('\n');
                }
            }
            
            return 'ç¨‹å¼åŸ·è¡Œå®Œæˆï¼ˆé€™æ˜¯æ¨¡æ“¬çµæœï¼‰';
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            if (!currentStudent || questions.length === 0) {
                showNotification('è«‹å…ˆç™»å…¥æˆ–ç­‰å¾…é¡Œç›®è¼‰å…¥ï¼', 'error');
                return;
            }
            
            const code = codeEditor.getValue();
            if (!code.trim()) {
                showNotification('è«‹å…ˆå¯«ä¸‹æ‚¨çš„ç¨‹å¼ç¢¼ï¼', 'error');
                return;
            }
            
            const currentQuestion = questions[0];
            students[currentStudent].answers[currentQuestion.id] = code;
            students[currentStudent].status = 'completed';
            students[currentStudent].submitTime = new Date().toLocaleString();
            
            saveData();
            showNotification('ç­”æ¡ˆå·²æäº¤ï¼è«‹ç­‰å¾…è€å¸«è©•åˆ†ã€‚');
            
            // é€šçŸ¥æ•™å¸«
            setTimeout(() => {
                if (currentRole === 'teacher') {
                    showNotification(`å­¸ç”Ÿ ${currentStudent} å·²å®Œæˆä½œç­”ï¼`);
                    updateStudentStatus();
                }
            }, 1000);
        }

        // æ›´æ–°å­¸ç”Ÿç‹€æ…‹
        function updateStudentStatus() {
            const studentStatus = document.getElementById('student-status');
            const studentCount = document.getElementById('student-count');
            
            const studentList = Object.values(students);
            studentCount.textContent = studentList.length;
            
            if (studentList.length === 0) {
                studentStatus.innerHTML = '<p style="color: #666;">ç›®å‰æ²’æœ‰å­¸ç”Ÿåƒèˆ‡</p>';
                return;
            }
            
            studentStatus.innerHTML = studentList.map(student => `
                <div class="student-card ${student.status === 'completed' ? 'completed' : ''}">
                    <div class="student-name">${student.name}</div>
                    <div class="status-indicator status-${student.status}">
                        ${student.status === 'completed' ? 'âœ… å·²å®Œæˆ' : 'â³ ä½œç­”ä¸­'}
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                        ç™»å…¥æ™‚é–“: ${student.loginTime}
                        ${student.submitTime ? `<br>æäº¤æ™‚é–“: ${student.submitTime}` : ''}
                    </div>
                    <button class="btn" onclick="viewStudentCode('${student.name}')" 
                            style="margin-top: 10px; font-size: 0.9em; padding: 8px 15px;">
                        æŸ¥çœ‹ç¨‹å¼ç¢¼
                    </button>
                </div>
            `).join('');
        }

        // æŸ¥çœ‹å­¸ç”Ÿç¨‹å¼ç¢¼
        function viewStudentCode(studentName) {
            const student = students[studentName];
            if (!student || questions.length === 0) return;
            
            const currentQuestion = questions[0];
            const code = student.answers[currentQuestion.id] || '// å­¸ç”Ÿå°šæœªæäº¤ç¨‹å¼ç¢¼';
            
            document.getElementById('modal-student-name').textContent = `${studentName} çš„ç¨‹å¼ç¢¼`;
            document.getElementById('modal-question-info').innerHTML = `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                    <strong>é¡Œç›®ï¼š</strong>${currentQuestion.title}
                </div>
            `;
            
            // åˆå§‹åŒ–æ¨¡æ…‹æ¡†ä¸­çš„ç·¨è¼¯å™¨
            const modalCodeContent = document.getElementById('modal-code-content');
            modalCodeContent.innerHTML = '';
            modalEditor = CodeMirror(modalCodeContent, {
                mode: 'python',
                theme: 'monokai',
                lineNumbers: true,
                readOnly: true,
                value: code
            });
            
            // è¼‰å…¥å·²æœ‰çš„åˆ†æ•¸
            const scoreInput = document.getElementById('score-input');
            scoreInput.value = student.scores[currentQuestion.id] || '';
            
            document.getElementById('code-modal').style.display = 'flex';
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal() {
            document.getElementById('code-modal').style.display = 'none';
            if (modalEditor) {
                modalEditor.toTextArea();
                modalEditor = null;
            }
        }

        // å„²å­˜åˆ†æ•¸
        function saveScore() {
            const studentName = document.getElementById('modal-student-name').textContent.replace(' çš„ç¨‹å¼ç¢¼', '');
            const score = document.getElementById('score-input').value;
            
            if (!score || isNaN(score) || score < 0 || score > 100) {
                showNotification('è«‹è¼¸å…¥æœ‰æ•ˆçš„åˆ†æ•¸ï¼ˆ0-100ï¼‰ï¼', 'error');
                return;
            }
            
            const currentQuestion = questions[0];
            students[studentName].scores[currentQuestion.id] = parseInt(score);
            saveData();
            
            showNotification(`å·²ç‚º ${studentName} è©•åˆ†ï¼š${score}åˆ†`);
            closeModal();
            updateStudentStatus();
        }

        // åˆ·æ–°å­¸ç”Ÿç‹€æ…‹
        function refreshStudentStatus() {
            updateStudentStatus();
            showNotification('ç‹€æ…‹å·²åˆ·æ–°ï¼');
        }

        // åŒ¯å‡ºçµæœ
        function exportResults() {
            if (Object.keys(students).length === 0) {
                showNotification('ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™å¯åŒ¯å‡ºï¼', 'error');
                return;
            }
            
            let csvContent = "å­¸ç”Ÿå§“å,ç™»å…¥æ™‚é–“,æäº¤æ™‚é–“,ç‹€æ…‹,ç¨‹å¼ç¢¼,åˆ†æ•¸\n";
            
            Object.values(students).forEach(student => {
                const currentQuestion = questions[0];
                const code = student.answers[currentQuestion?.id] || '';
                const score = student.scores[currentQuestion?.id] || '';
                
                csvContent += `"${student.name}","${student.loginTime}","${student.submitTime || ''}","${student.status}","${code.replace(/"/g, '""')}","${score}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `python_test_results_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('çµæœå·²åŒ¯å‡ºç‚ºCSVæª”æ¡ˆï¼');
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.background = type === 'error' ? '#f44336' : '#4CAF50';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // è³‡æ–™å„²å­˜å’Œè¼‰å…¥ï¼ˆä½¿ç”¨è¨˜æ†¶é«”å„²å­˜ï¼‰
        function saveData() {
            // åœ¨å¯¦éš›éƒ¨ç½²ä¸­ï¼Œé€™è£¡æ‡‰è©²ç™¼é€åˆ°å¾Œç«¯ä¼ºæœå™¨
            window.tempData = {
                questions: questions,
                students: students
            };
        }

        function loadData() {
            // åœ¨å¯¦éš›éƒ¨ç½²ä¸­ï¼Œé€™è£¡æ‡‰è©²å¾å¾Œç«¯ä¼ºæœå™¨è¼‰å…¥
            if (window.tempData) {
                questions = window.tempData.questions || [];
                students = window.tempData.students || {};
            }
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('code-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
